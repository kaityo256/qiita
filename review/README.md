
# 数式を含むMarkdownファイルをRe:VIEWにする

# はじめに

数式を含む文書を書くことが多いのですが、いつもMarkdownで書いています。Markdownはいろいろなことができませんが、逆に「いろいろなこと」をしないように書くようになるので、慣れるとLaTeXより楽だったりします。とりあえず私は

* 大きなブロック(章等)が表現できる
* 箇条書きなどがある
* リンクを張れる
* 数式を入れられる
* 画像を入れられる

だけができれば良く、それ以上のことは要求しません。

VSCodeで書くと数式も含めてプレビューできるので便利です。そのままGitHubに上げても数式は見えませんが、適当なテンプレートを使ってPandocで変換してやればGitHub Pagesで数式が見えるようになり、ついでにレスポンシブ対応にもできて便利です。例えば[一週間でなれる！スパコンプログラマ](https://kaityo256.github.io/sevendayshpc/)はそうやって作っています。

このようにMarkdownは気軽に書けていいのですが、方言が極めて多く、特に数式の扱いが統一されていないのが困りもので、変換時に様々なトラブルを引き起こします。

というわけで今回、こうやって書いた「数式を含むMarkdown」をRe:VIEW StarterでPDF化する際に困ったことをまとめておきます。以下、Re:VIEW Starterを使う関係で、Re:VIEWのバージョンは2.5を想定します。

# 方針

マークダウンファイル`*.md`を[md2review](https://github.com/takahashim/md2review)で`*.re`に変換します。ただし、数式が変換できないので、事前に変換スクリプトをかませておきます。また、数式中にアンダースコアがあると変換がおかしくなるので、それもエスケープしておき、後で元に戻す必要があります。

# 数式

Markdownに数式を入れる方法はいくつか流儀がありますが、ここではインライン数式は`$`、ブロック数式は`$$`で囲むことにします。VSCodeではプレビューにKaTeXを使う関係で、`aligned`まわりとか、微妙にQiitaと違ったりします。

## アンダースコアのエスケープ

まず困るのが、アンダースコアが文中に二回出現すると、強調構文と解釈されてしまうことです。md2reviewは変換にRedcarpetを使っていますが、Redcarpetは数式に対応しておらず、数式中に出現するアンダースコアをMarkdownの強調と解釈してしまいます。こんなコードを書いてみましょう。

```rb:test.rb
require 'redcarpet'
require 'redcarpet/render/review'
render = Redcarpet::Render::ReVIEW.new()
mk = Redcarpet::Markdown.new(render)
puts mk.render(ARGV[0])
```

これに`$t_1$`を食わせてもそのままスルーされます。

```txt
$ ruby test.rb '$t_1$'

$t_1$
```

しかし、`From $t_1$ to $t_2$`みたいなのを食わせるとこうなります。

```txt
$ ruby test.rb 'From $t_1$ to $t_2$'

From $t@<b>{1$ to $t}2$
```

途中にある二つのアンダースコアに挟まれた部分を強調だと認識されてしまったのです。これは、ブロック内でも同じなどね、インライン、ブロックともに数式中のアンダースコアをエスケープしてやる必要があります。なんでも良いですが、なんかRe:VIEWっぽく``

